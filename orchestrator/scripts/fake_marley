#!/usr/bin/env bash
set -euo pipefail

# ----------------------------
# Fake Marley (test only)
# ----------------------------

SEP=","
HEADER="false"

FILTER_MAIN_APP=""
FILTER_ENV=""
FILTER_FQDN=""

# -----------------------------------------------------------------------------
# Fake inventory dataset
#
# This fake implementation supports multiple rows. Add/remove lines as needed.
# Format per line: main_app,environment,fqdn,os_name
# -----------------------------------------------------------------------------
INVENTORY_DATA=$(cat <<'EOF'
ICOM,UAT,10.81.6.20,linux
ICOM,PRD,10.81.6.20,linux
Jaguar,UAT,10.81.6.20,linux
Jaguar,PRD,10.81.6.20,linux
ICOM,UAT,10.81.6.20,linux
Jaguar,PRD,10.81.6.20,linux
EOF
)

# ----------------------------
# Parse args
# ----------------------------
while [[ $# -gt 0 ]]; do
  case "$1" in
    -F)
      SEP="$2"
      shift 2
      ;;
    -H)
      HEADER="true"
      shift
      ;;
    --main_app)
      FILTER_MAIN_APP="$2"
      shift 2
      ;;
    --environment)
      FILTER_ENV="$2"
      shift 2
      ;;
    --FQDN)
      FILTER_FQDN="$2"
      shift 2
      ;;
    *)
      break
      ;;
  esac
done

# Remaining argument = requested columns
COLUMNS_RAW="${1:-}"
[[ -n "$COLUMNS_RAW" ]] || {
  echo "marley: missing column list" >&2
  exit 1
}

# Normalize columns
IFS=',' read -r -a COLUMNS <<<"$(echo "$COLUMNS_RAW" | tr -d ' ')"

# -----------------------------------------------------------------------------
# Output (filter + projection)
# -----------------------------------------------------------------------------

# Print header once.
if [[ "$HEADER" == "true" ]]; then
  printf "%s\n" "$(IFS="$SEP"; echo "${COLUMNS[*]}")"
fi

# Iterate all inventory rows and print those that match filters.
matched="false"
while IFS= read -r line; do
  [[ -n "$line" ]] || continue

  IFS=',' read -r MAIN_APP ENVIRONMENT FQDN OS_NAME <<<"$line"

  [[ -n "$FILTER_MAIN_APP" && "$FILTER_MAIN_APP" != "$MAIN_APP" ]] && continue
  [[ -n "$FILTER_ENV" && "$FILTER_ENV" != "$ENVIRONMENT" ]] && continue
  [[ -n "$FILTER_FQDN" && "$FILTER_FQDN" != "$FQDN" ]] && continue

  values=()
  for col in "${COLUMNS[@]}"; do
    case "$col" in
      main_app)     values+=("$MAIN_APP") ;;
      environment)  values+=("$ENVIRONMENT") ;;
      fqdn)         values+=("$FQDN") ;;
      os_name)      values+=("$OS_NAME") ;;
      *)            values+=("") ;;
    esac
  done

  matched="true"
  printf "%s\n" "$(IFS="$SEP"; echo "${values[*]}")"

done <<<"$INVENTORY_DATA"

# If no match, behave like marley: print nothing and exit 0.
[[ "$matched" == "true" ]] || exit 0